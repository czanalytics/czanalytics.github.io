<!DOCTYPE html>
<html lang="en">

<head>
  <title>Price</title>
    <meta charset="utf-8" />
  <link rel="icon" type="image/x-icon" href="./favicon.png" />
    <link
        rel="stylesheet"
        href="https://pyscript.net/latest/pyscript.css"/>
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <link rel="stylesheet" href="./assets/css/examples.css" />
</head>

<body>
<section class="pyscript">
  <div id="folium"></div>
   
<py-config>
  packages = [
  "https://cdn.holoviz.org/panel/0.14.3/dist/wheels/bokeh-2.4.3-py3-none-any.whl",
  "folium", "pandas", "numpy", "panel==0.13.1"]
  plugins = ["https://pyscript.net/latest/plugins/python/py_tutor.py"]
  [[fetch]]
        files = ["./price.py", "./request.py"]
</py-config>

<py-script>    
from price import approx # import price doesn't work

print( approx(1966.0526) )

#model_conf = co2_foo()
#ms = model_conf['models']
</py-script>    

<py-script>
import asyncio
import json
from request import request  # import our request function.

#curl -H 'Api-Key: s3cr3t_k3y' -s http://0.0.0.0:3333

#curl -s -X GET -H 'Content-type: application/json' -H 'Api-Key: s3cr3t_k3y' http://0.0.0.0:3333/api/route --data '{"id":"230801-001", "da":"23-08-01", "lat1":48.86471, "lon1":2.23901, "lat2":52.36760, "lon2":4.90410, "meta":"paris-amsterdam"}'
# https://docs.pyscript.net/latest/guides/http-requests.html
# https://pyodide.org/en/stable/usage/api/python-api/http.html

import json

from pyodide.http import pyfetch

async def lane_api():
  print("main_api()")

  #url = "http://0.0.0.0:3333"
  url = "http://127.0.0.1:3333" 
  url = "https://back-end-buckinghamshire.runblade.host"  
  payload = {"id": "230801-001", "da": "23-08-01", "lat1": 48.86471, "lon1": 2.23901, "lat2": 52.36760, "lon2": 4.90410, "meta": "par-ams"}
  
  print(f"{url}/api/price")
  print("POST body: ", payload)

  body = json.dumps({"id": "230801-001", "da": "23-08-01", "lat1": 48.86471, "lon1": 2.23901, "lat2": 52.36760, "lon2": 4.90410, "meta": "par-ams"})

  headers = {"Content-type": "application/json"}

  r = await request(f"{url}/api", method="GET", headers=headers)
  print(f"GET request=> status:{r.status}, json:{await r.json()}")
  
  #s = await request(f"{url}/api/tc", method="GET", headers=headers)
  #print(f"GET request=> status:{s.status}, json:{await s.json()}")

  t = await request(f"{url}/api/price", body=body, method="POST", headers=headers)
  j = await t.json()
  print(f"GET request=> status:{t.status}, json:{j}")
  print(f"price = {j['price']} EUR  ({j['price_lo']}, {j['price_hi']})")

  #t = await request(f"{url}/api/eta", body=body, method="POST", headers=headers)
  #print(f"GET request=> status:{t.pstatus}, json:{await t.json()}")
  
  #t = await request(f"{url}/api/co", body=body, method="POST", headers=headers)
  #print(f"GET request=> status:{t.status}, json:{await t.json()}")

  print("lane_api")


asyncio.ensure_future(lane_api()) # 

</py-script>    

<py-script>
import asyncio
import json
from request import request  # import our request function.

async def main_http():
  print('main_http')
  baseurl = "https://jsonplaceholder.typicode.com"

  # GET
  headers = {"Content-type": "application/json"}
  response = await request(f"{baseurl}/posts/2", method="GET", headers=headers)
  print(f"GET request=> status:{response.status}, json:{await response.json()}")

  # POST
  body = json.dumps({"title": "test_title", "body": "test body", "userId": 1})
  new_post = await request(f"{baseurl}/posts", body=body, method="POST", headers=headers)
  print(f"POST request=> status:{new_post.status}, json:{await new_post.json()}")

  # PUT
  body = json.dumps({"id": 1, "title": "test_title", "body": "test body", "userId": 2})
  new_post = await request(f"{baseurl}/posts/1", body=body, method="PUT", headers=headers)
  print(f"PUT request=> status:{new_post.status}, json:{await new_post.json()}")

  # DELETE
  new_post = await request(f"{baseurl}/posts/1", method="DELETE", headers=headers)
  print(f"DELETE request=> status:{new_post.status}, json:{await new_post.json()}")
  print('main_http OK')

#asyncio.ensure_future(main_http()) #ok
</py-script>

<py-script>    
import json
from pyodide.http import pyfetch

from price import login 

import asyncio

async def api_foo():
  print('api_foo')

async def api_get():
  print('api_get')
  p = await login("foo", "bar")
  print(p)

async def main():
  _ = await asyncio.gather(api_foo(), api_get())

#asyncio.ensure_future(main())
</py-script>    

<div class="grid grid-rows-4 p-4 bg-blue-100 border-2 justify-items-left">
  
   <div>      
        <select name="flight-mode" id="flight-mode-select">
            <option value="one">EUR</option>
            <option value="gbp">GBP</option>
            <option value="sek">SEK</option>
            <option value="sek">CHF</option>
            <option value="usd">USD</option>
        </select>
    </div>

    <div>
        <h4 class="font-semibold">From</h4>
        <input id="dep" class="w-3/4 bg-white border-4">
    </div>

    <div>
        <h4 class="font-semibold">To</h4>
        <input id="ret" class="w-3/4 bg-white border-4">
    </div>

    <div>
        <button id="book-flight" class="p-2 my-2 bg-green-200 border-2 border-gray-400 rounded-lg">Get Price</button>
        <p id="flight-info" class="italic"> Avg. price with 68% conf. range (low, high) </p>
    </div>
</div>

<!--  
-->

<py-script>
import js
from js import document
from pyodide.ffi import create_proxy

from price import price_est # !
from price import _flight_mode_change, _book_flight

flight_mode_change = create_proxy(_flight_mode_change)

document.getElementById("flight-mode-select").addEventListener("input", flight_mode_change)

book_flight = create_proxy(_book_flight)
document.getElementById("book-flight").addEventListener("click", book_flight)

flight_mode_change()
</py-script>

<py-script>
import pandas as pd

from price import get_data # !

d = get_data()

d_ = d.loc[(d['Origin'] == 'ES70') & (d['Destination'] == 'PT11') ]

print (d_)
</py-script>

</body>
